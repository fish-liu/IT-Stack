
本文转载自：https://www.jianshu.com/p/efc4ff85932d 


MySQL的文件结构

-----------------------------------------------

> 当MySQL不作为内存数据库，而作为磁盘数据库时，所有的文件最终都要放在磁盘中，表本质上就是磁盘上的文件。

![Mysql主从](/images/mysql-file.png)


### MySQL的目录结构

#### MyISAM数据库引擎

```sql
|--- mysql
    |--- data
        |--- 数据库
            |--- 表名.frm
            |--- 表名.myd
            |--- 表名.myi
            |--- 表名.log     
```


#### InnoDB数据库引擎

```sql
|--- mysql
    |--- data
        |--- ib_logfile0
        |--- ib_logfile1
        |--- ibdata1
        |--- 数据库
            |--- 表名.frm
            |--- 表名.ibd
```

#### 与数据库引擎无关的.frm

在上面的目录结构中，不难发现，.frm文件是两个数据库引擎都共有的文件，那么它的存储了哪些信息？有哪些功能呢？

- 保存表的元数据，包括表结构定义
- 可以在数据库奔溃的时候恢复表结构（如何恢复？比较简单，文件替换就行，这里就不说了，大家有兴趣的话，可以百度搜索）


#### MyISAM引擎文件

这种数据库引擎特点是快，所以对文件的划分是比较独立的

- .myd：全称 .mydata，存放表数据
- .myi：全称 .myindex，存放索引文件
- .log：日志文件


#### InnoDB引擎文件

这种引擎更加关注事务，多以采用表空间的形式来管理数据、存储表数据、存储索引

**文件：**

- ibdata1、ibdata2等：InnoDB 的共享表空间（系统表空间文件），存储InnoDB系统信息、数据字典、用户数据库表数据、索引，Undo log

- .ibd：单表表空间文件，每个表使用一个表空间文件，存放用户数据库表数据、索引

- ib_logfile0、ib_logfile1：日志文件（InnoDB的事务日志，又称Redo log）

InnoDB管理主要基于两个文件：表空间数据文件、日志文件。InnoDB可以使用共享表空间或独立表空间

- 共享表空间
  只为每张表单独建立.frm文件，将所有表数据和索引保存到.ibdata1文件中去，缺点是拷贝时需要拷贝整个文件，且删除表后容易造成碎片

- 独立表空间
  为每张表建立一个.frm文件、.ibd文件。.ibd文件用来存储表数据、索引和插入缓冲。每个表对应的撤销（undo）信息，系统事务信息，二次写缓冲等还是存放在了原来的共享表空间内（ibdata1文件）



### InnoDB的存储结构

InnoDB表中的每行数据是基于B+树存储的，其中B+树中的顺序依据是主键的顺序，称为索引组织表。B+树存储在数据文件中，在B+树之外，InnoDB对数据文件中数据的管理和组织定义一个新的逻辑结构如下图所示：

![InnoDB的存储结构](/images/tablespace.png)

所有的数据都被逻辑地存放在表空间中，表空间中的数据分类为各个段（segment）：数据段、索引段、回滚段等。为了 便于管理，在各个段（segment）中继续拆分为区（extends），区再细化拆分为连续的页（Page），页（Page）是InnoDB磁盘管理的最小单位（即InnoDB从磁盘读取和写入都是以页为单位进行的）。

- 段（segment）的类型有：数据段、索引段、回滚段等

- 区连续的页组成的空间，任何情况下区的大小都为1MB，一个区有64个页（页的大小为16K）

- 页（Page）类型有：数据页、Undo页、系统页、事务数据页、插入缓冲位图页、以及插入缓冲空闲列表页。innodb磁盘管理的最小单位，默认大小是16K。

- 数据是按行存放的，每页最少两行数据，最多7992行


数据页的结构：

 File Header（文件头）–>38byte
 
 Page Header（页头）–>56byte
 
 Infimun+Supremum Records
 
 User Records（用户记录，即行记录）
 
 Free Space（空闲空间）
 
 Page Directory（页目录）
 
 File Trailer（文件结尾信息）–>8byte
 
 ![InnoDB的存储结构](/images/page.png)


### InnoDB的索引结构

InnoDB使用B+Tree的方式存储索引。

Innodb的一个表可能包含多个索引，每个索引都使用B+树来存储。而索引包括聚集索引和二级索引，聚集索引使用表的主键作为索引键，包含表的所有字段。二级索引只包含索引键和聚集索引键（主键）的内容，不包括其他字段。

每一个索引都是一棵B+树，每棵B+树由很多页面组成，而每个页面大小一般为16K。从B+树的组织结构来看，B树的页面可分为：

叶子节点：B树层次为0的页面，存储记录的所有内容。
非叶子节点：B树层次大于0的页面，只存储索引键和页面指针。

